name: RPM Build
on:
    push:
      # Sequence of patterns matched against refs/tags
      tags:
        - 'v*' # Push events to matching v*, i.e. v1.0, v20.15.10

jobs:
  build:
    strategy:
      matrix:
        dist: ["el8", "el9", "el10"]

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - run: sudo apt install rpm file curl
    - run: mkdir -p ~/rpmbuild/SOURCES
    - run: rpmbuild --undefine=_disable_source_fetch --define '_unitdir /usr/lib/systemd/system' --define 'dist .${{ matrix.dist }}' -ba slurm-job-exporter.spec
    - name: Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: /home/runner/rpmbuild/RPMS/noarch/*
